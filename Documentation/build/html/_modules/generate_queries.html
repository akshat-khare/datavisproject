<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>generate_queries &mdash; Twitter Analytics 0.1 documentation</title>
  

  
  

  

  

  

  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/jquery-ui/jquery-ui.min.css" type="text/css" />
  
    <link rel="stylesheet" href="../_static/css/t3more.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="Twitter Analytics 0.1 documentation" href="#"/>
        <link rel="up" title="Module code" href="index.html"/> 
  <script src="../_static/js/modernizr.min.js"></script>
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        

        <ul class="sidebartop">

          <li class="docsite">
            <a href="https://docs.typo3.org"><img src="../_static/img/typo3-documentation.png" class="logo" /></a>
          </li>

          <li class="project">
            <a href="../index.html">
              Twitter Analytics<br>0.1</a>
          </li><li class="nolink search">
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search this project" id="searchinput" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div></li>

        </ul>

        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction to twitter analytics system</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../introduction.html#major-parts-of-the-system">Major parts of the system</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../twitter_stream.html">Read data from Twitter API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../twitter_stream.html#user-timeline-api">User Timeline API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../twitter_stream.html#stream-sample-api">Stream Sample API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../twitter_stream.html#user-timeline-api-code-documentation">User Timeline API Code Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../twitter_stream.html#stream-sample-api-code-documentation">Stream Sample API Code Documentation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../kafka.html">Putting tweets to Kafka</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../kafka.html#kafka-tweet-producer-documentation">Kafka Tweet Producer Documentation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../neo4j_data_ingestion.html">Ingesting data into Neo4j</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../neo4j_data_ingestion.html#data-stored-in-neo4j">Data stored in neo4j</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../neo4j_data_ingestion.html#user-network">User network</a></li>
<li class="toctree-l3"><a class="reference internal" href="../neo4j_data_ingestion.html#tweet-network">Tweet network</a></li>
<li class="toctree-l3"><a class="reference internal" href="../neo4j_data_ingestion.html#indexing-network">Indexing network</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../neo4j_data_ingestion.html#ingesting-the-data-into-neo4j-logic">Ingesting the data into neo4j : Logic</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../neo4j_data_ingestion.html#improving-ingestion-rate-using-transaction">Improving ingestion rate using transaction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../neo4j_data_ingestion.html#indexing">Indexing</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../neo4j_data_ingestion.html#running-the-ingestion-script">Running the ingestion script</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../neo4j_data_ingestion.html#streaming-data">Streaming data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../neo4j_data_ingestion.html#user-timeline-data">User Timeline data</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../neo4j_data_ingestion.html#neo4j-ingestion-rates">Neo4j Ingestion Rates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../neo4j_data_ingestion.html#code-documentation-for-neo4j-data-ingestion">Code Documentation for Neo4j data ingestion</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../mongoDB_data_ingestion.html">Ingesting data into MongoDB</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../mongoDB_data_ingestion.html#why-store-in-mongodb">Why store in MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mongoDB_data_ingestion.html#data-format-in-mongodb">Data Format in mongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mongoDB_data_ingestion.html#mongodb-v-s-neo4j">mongoDB v/s neo4j</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mongoDB_data_ingestion.html#ingesting-the-data-into-mongodb-logic">Ingesting the data into mongoDB : Logic</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../mongoDB_data_ingestion.html#improving-ingestion-rate-using-transactions">Improving ingestion rate using transactions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mongoDB_data_ingestion.html#improving-ingestion-rate-using-parallel-multiple-process">Improving ingestion rate using parallel multiple process</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../mongoDB_data_ingestion.html#ingesting-the-data-into-mongodb-practical-side">Ingesting the data into mongoDB : Practical side</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mongoDB_data_ingestion.html#mongodb-ingestion-rates">MongoDB Ingestion Rates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mongoDB_data_ingestion.html#module-ingest_raw">Code Documentation for mongoDB ingestion</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../neo4j_query_generation.html">Neo4j: API to generate cypher queries</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../neo4j_query_generation.html#template-of-a-general-query">Template of a general query</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../neo4j_query_generation.html#basic-abstraction">Basic Abstraction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../neo4j_query_generation.html#naming-entities">Naming entities</a></li>
<li class="toctree-l3"><a class="reference internal" href="../neo4j_query_generation.html#variable-attributes">Variable attributes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../neo4j_query_generation.html#returns">Returns</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../neo4j_query_generation.html#creating-a-custom-query-through-dashboard-api-behind-the-scenes">Creating a custom query through dashboard API : Behind the scenes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../neo4j_query_generation.html#code-documentation-for-neo4j-query-generation">Code Documentation for Neo4j query generation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../mongoDB_query_generation.html">Generating queries in mongoDB</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../mongoDB_query_generation.html#generic-api-for-mongodb-idea">Generic API for mongoDB : Idea</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../mongoDB_query_generation.html#mongodb-query-execution-code-documentation">MongoDB query execution code documentation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../postprocessing.html">About Post processing functions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../postprocessing.html#need-of-post-processing-function">Need of post processing function</a></li>
<li class="toctree-l2"><a class="reference internal" href="../postprocessing.html#format-of-post-processing-functions">Format of post processing functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../postprocessing.html#executing-post-processing-function">Executing post processing function</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../dag.html">Composing multiple queries : DAG</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../dag.html#basic-terminology">Basic terminology</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dag.html#idea-behind-a-dag">Idea behind a DAG</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dag.html#building-a-dag-from-queries">Building a DAG from queries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dag.html#dag-in-airflow">DAG in airflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dag.html#creating-custom-metric">Creating custom metric</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dag.html#code-documentation-for-dag-abstraction">Code Documentation for DAG abstraction</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../flink.html">Generating alerts using Apache Flink</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../flink.html#alert-specification-abstraction">Alert Specification Abstraction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../flink.html#back-end-process">Back-end process</a></li>
<li class="toctree-l2"><a class="reference internal" href="../flink.html#example-finding-viral-hashtags">Example - Finding viral hashtags</a></li>
<li class="toctree-l2"><a class="reference internal" href="../flink.html#flink-code-generator-documentation">Flink Code Generator Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../flink.html#flink-api-documentation">Flink API Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../flink.html#flink-alerts-consumer">Flink Alerts Consumer</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../benchmarking.html">Benchmarking the query answering</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../benchmarking.html#neo4j-queries">Neo4j queries</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../benchmarking.html#simple-queries">Simple Queries</a></li>
<li class="toctree-l3"><a class="reference internal" href="../benchmarking.html#complex-queries">Complex Queries</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../benchmarking.html#mongodb-queries">MongoDB queries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../benchmarking.html#code-documentation-for-benchmarking">Code Documentation for benchmarking</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../dashboard_website.html">Dashboard Website</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../dashboard_website.html#major-parts-of-the-dashboard-website">Major parts of the dashboard website</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../dashboard_website.html#hashtags">Hashtags</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dashboard_website.html#mentions">Mentions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dashboard_website.html#urls">URLs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dashboard_website.html#alerts">Alerts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dashboard_website.html#dag">DAG</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../dashboard_website.html#use-cases">Use Cases</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../dashboard_website.html#viewing-top-10-popular-hashtags">Viewing top 10 popular hashtags</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dashboard_website.html#viewing-usage-history-of-hashtag">Viewing usage history of  hashtag</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dashboard_website.html#viewing-sentiment-history-of-hashtag">Viewing sentiment history of  hashtag</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dashboard_website.html#creating-a-mongodb-query">Creating a mongoDB query</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dashboard_website.html#creating-neo4j-queries">Creating neo4j queries</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dashboard_website.html#create-post-processing-function">Create Post processing function</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dashboard_website.html#view-queries">View Queries</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dashboard_website.html#create-dag">Create DAG</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dashboard_website.html#view-dags">View DAGs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dashboard_website.html#create-custom-metric">Create Custom metric</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dashboard_website.html#create-alert">Create Alert</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dashboard_website.html#view-alerts">View Alerts</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../running.html">Getting the system running</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../running.html#setting-up-the-environment">Setting up the environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../running.html#running-the-system">Running the system</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../running.html#collecting-data">Collecting data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../running.html#ingesting-data">Ingesting data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../running.html#running-the-dashboard">Running the dashboard</a></li>
<li class="toctree-l3"><a class="reference internal" href="../running.html#running-flink-and-kafka">Running Flink and Kafka</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Twitter Analytics</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
          <li><a href="index.html">Module code</a> &raquo;</li>
    <li>generate_queries</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody" class="toBeIndexed">
            
  <h1>Source code for generate_queries</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module to generate cypher code for inputs taken from user though dashboard API.</span>

<span class="sd">The :mod:`generate_queries` module contains the classes:</span>

<span class="sd">- :class:`generate_queries.CreateQuery`</span>

<span class="sd">One can use the :func:`generate_queries.CreateQuery.create_query` to build a cypher query.</span>

<span class="sd">Example illustrating how to create a query which gives the userids and their tweet counts who have used a certian hashtag.</span>

<span class="sd">&gt;&gt;&gt; actors=[(&quot;u&quot;,&quot;USER&quot;),(&quot;t&quot;,&quot;TWEET&quot;),(&quot;t1&quot;,&quot;TWEET&quot;)]</span>
<span class="sd">&gt;&gt;&gt; attributes=[[],[(&quot;hashtag&quot;,&quot;{hash}&quot;)],[]]</span>
<span class="sd">&gt;&gt;&gt; relations=[(&quot;u&quot;,&quot;TWEETED&quot;,&quot;t&quot;,&quot;&quot;,&quot;&quot;),(&quot;u&quot;,&quot;TWEETED&quot;,&quot;t1&quot;,&quot;&quot;,&quot;&quot;)]</span>
<span class="sd">&gt;&gt;&gt; cq = CreateQuery();</span>
<span class="sd">&gt;&gt;&gt; return_values=&quot;u.id,count(t1)&quot;</span>
<span class="sd">&gt;&gt;&gt; ret_dict = cq.create_query(actors,attributes,relations,return_values)</span>
<span class="sd">&gt;&gt;&gt; pprint(ret_dict,width=150)</span>

<span class="sd">Example of a query which uses time indexing in a relationship:</span>

<span class="sd">&gt;&gt;&gt; actors = [(&#39;x&#39;, &#39;USER&#39;), (&#39;u1&#39;, &#39;USER&#39;)] + [(&#39;t1&#39;, &#39;TWEET&#39;), (&#39;t2&#39;, &#39;TWEET&#39;)]</span>
<span class="sd">&gt;&gt;&gt; attributes = [[(&#39;id&#39;, &#39;12&#39;)], [(&#39;id&#39;, &#39;24&#39;)]]+[[(&#39;hashtag&#39;, &#39;BLUERISING&#39;)], [(&#39;retweet_of&#39;, &#39;t1&#39;), (&#39;has_mention&#39;, &#39;u1&#39;)]]</span>
<span class="sd">&gt;&gt;&gt; relations = [(&#39;x&#39;, &#39;FOLLOWS&#39;, &#39;u1&#39;, &#39;&#39;, &#39;&#39;), (&#39;x&#39;, &#39;TWEETED&#39;, &#39;t2&#39;, &#39;24&#39;, &#39;48&#39;)]</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">jinja2</span> <span class="k">as</span> <span class="nn">jj</span>
<span class="kn">from</span> <span class="nn">neo4j.v1</span> <span class="k">import</span> <span class="n">GraphDatabase</span><span class="p">,</span> <span class="n">basic_auth</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1">###########################################################################################################</span>

<span class="n">order</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;STARTED_FOLLOWING&quot;</span><span class="p">,</span><span class="s2">&quot;TWEETED&quot;</span><span class="p">,</span><span class="s2">&quot;FOLLOWS&quot;</span><span class="p">]</span>
<span class="n">match_frames</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;{</span><span class="si">% f</span><span class="s2">or i in num_frames %} (run:RUN) -[:HAS_FRAME]-&gt; (frame{{i}}:FRAME),{</span><span class="si">% e</span><span class="s2">ndfor %}&quot;&quot;&quot;</span>
<span class="n">where_frames</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;WHERE {</span><span class="si">% f</span><span class="s2">or ft in frame_times %} frame{{ft[0]}}.end_t &gt;= {{ft[1]}} AND frame{{ft[0]}}.start_t &lt;= {{ft[2]}} AND{</span><span class="si">% e</span><span class="s2">ndfor %}&quot;&quot;&quot;</span>
<span class="n">match_events</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;{</span><span class="si">% f</span><span class="s2">or e in events %}(frame{{e[0]}}) -[:{{e[1]}}]-&gt; (event{{e[0]}} :{{e[2]}}), {</span><span class="si">% e</span><span class="s2">ndfor %}&quot;&quot;&quot;</span>
<span class="n">match_actors</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;{</span><span class="si">% f</span><span class="s2">or e in events %}(event{{e[0]}}) -[:{{e[1]}}]-&gt; ({{e[2]}}), {</span><span class="si">% e</span><span class="s2">ndfor %}&quot;&quot;&quot;</span>
<span class="n">match_actors2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;{</span><span class="si">% f</span><span class="s2">or r in rels %}({{r[0]}}) -[:{{r[1]}}]-&gt; ({{r[2]}}), {</span><span class="si">% e</span><span class="s2">ndfor %}&quot;&quot;&quot;</span>
<span class="n">tweet_attribs</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;{</span><span class="si">% f</span><span class="s2">or tp in tweet_properties %}({{tp[0]}}) -[:{{tp[1]}}]-&gt; ({{tp[2]}}), {</span><span class="si">% e</span><span class="s2">ndfor %}&quot;&quot;&quot;</span>
<span class="n">match_actors_solo</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;{</span><span class="si">% f</span><span class="s2">or a in actors %}({{a}}), {</span><span class="si">% e</span><span class="s2">ndfor %}&quot;&quot;&quot;</span>
<span class="n">returns</span>  <span class="o">=</span> <span class="s2">&quot;&quot;&quot;RETURN {{ret_values}}&quot;&quot;&quot;</span>
<span class="n">unwinds</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;{</span><span class="si">%  f</span><span class="s2">or uw in unwinds %}UNWIND {</span><span class="si">% r</span><span class="s2">aw %}{{</span><span class="si">% e</span><span class="s2">ndraw %}{{uw}}{</span><span class="si">% r</span><span class="s2">aw %}}{</span><span class="si">% e</span><span class="s2">ndraw %} AS {{uw}}_value</span>
<span class="s2">{</span><span class="si">% e</span><span class="s2">ndfor %}&quot;&quot;&quot;</span>
<span class="n">total_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">{</span><span class="si">% f</span><span class="s2">or p in parts %}{{p}}</span>
<span class="s2">{</span><span class="si">% e</span><span class="s2">ndfor %}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">encode</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;TWEETED&quot;</span><span class="p">:(</span><span class="s2">&quot;HAS_TWEET&quot;</span><span class="p">,</span><span class="s2">&quot;TWEET_EVENT&quot;</span><span class="p">),</span><span class="s2">&quot;STARTED_FOLLOWING&quot;</span><span class="p">:(</span><span class="s2">&quot;HAS_FOLLOW&quot;</span><span class="p">,</span><span class="s2">&quot;FOLLOW_EVENT&quot;</span><span class="p">)}</span>
<span class="n">encode_left</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;TWEETED&quot;</span><span class="p">:</span><span class="s2">&quot;TE_USER&quot;</span><span class="p">,</span><span class="s2">&quot;STARTED_FOLLOWING&quot;</span><span class="p">:</span><span class="s2">&quot;FE_FOLLOWER&quot;</span><span class="p">}</span>
<span class="n">encode_right</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;TWEETED&quot;</span><span class="p">:</span><span class="s2">&quot;TE_TWEET&quot;</span><span class="p">,</span><span class="s2">&quot;STARTED_FOLLOWING&quot;</span><span class="p">:</span><span class="s2">&quot;FE_FOLLOWED&quot;</span><span class="p">}</span>

<div class="viewcode-block" id="CreateQuery"><a class="viewcode-back" href="../neo4j_query_generation.html#generate_queries.CreateQuery">[docs]</a><span class="k">class</span> <span class="nc">CreateQuery</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class containing functions to generate query.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">L</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">max</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="n">L</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">already_described</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="CreateQuery.generate_node"><a class="viewcode-back" href="../neo4j_query_generation.html#generate_queries.CreateQuery.generate_node">[docs]</a>    <span class="k">def</span> <span class="nf">generate_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="nb">type</span><span class="p">,</span><span class="n">props</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function for :func:`generate_queries.CreateQuery.conditional_create`</span>

<span class="sd">        :param var: the variable name of the entity</span>
<span class="sd">        :param type: the type of the entity. Observe we pass type as :USER and NOT as USER</span>
<span class="sd">        :param props: the properties of the entity.</span>
<span class="sd">        :returns: the code for the node as neo4j node enclosed in ()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="s2">&quot;{{var}} {{type}} {</span><span class="si">% r</span><span class="s2">aw %}{{</span><span class="si">% e</span><span class="s2">ndraw %}{</span><span class="si">% f</span><span class="s2">or av in props %}{{av[0]}}:{{av[1]}}, {</span><span class="si">% e</span><span class="s2">ndfor %}&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">jj</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">props</span><span class="o">=</span><span class="n">props</span><span class="p">,</span><span class="n">var</span><span class="o">=</span><span class="n">var</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="c1">## the replace are required to remove these {} braces. though, syntactically correct in cypher but not so pleasant to read in the generated query.</span>
        <span class="k">return</span> <span class="p">((</span><span class="n">c</span><span class="o">+</span><span class="s2">&quot;}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; )&quot;</span><span class="p">,</span><span class="s2">&quot;)&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CreateQuery.conditional_create"><a class="viewcode-back" href="../neo4j_query_generation.html#generate_queries.CreateQuery.conditional_create">[docs]</a>    <span class="k">def</span> <span class="nf">conditional_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">entity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Condionally provide the attributes of the node if not already created, else directly use the name of the variable create earlier.</span>
<span class="sd">        If already create, pass empty list of properties.</span>

<span class="sd">        :param entity: the entity which to check and create</span>
<span class="sd">        :returns: the code for the node as neo4j node enclosed in ()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt;&gt; &quot;</span><span class="p">,</span><span class="n">entity</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">already_described</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">entity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">already_described</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_node</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,[])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;:TWEET&quot;</span><span class="p">):</span>
                <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_node</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="p">[</span><span class="n">entity</span><span class="p">],[])</span>
            <span class="k">elif</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;:USER&quot;</span><span class="p">):</span>
                <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_node</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="p">[</span><span class="n">entity</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">entity</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">already_described</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">node</span></div>


<div class="viewcode-block" id="CreateQuery.create_query"><a class="viewcode-back" href="../neo4j_query_generation.html#generate_queries.CreateQuery.create_query">[docs]</a>    <span class="k">def</span> <span class="nf">create_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">actors</span><span class="p">,</span><span class="n">attributes</span><span class="p">,</span><span class="n">relations</span><span class="p">,</span> <span class="n">return_values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Takes a list of attributes and relationships between them and return a cypher code as string.</span>
<span class="sd">        For the format of the lists see the examples.</span>

<span class="sd">        :param actors: the variable names, types of the attributes</span>
<span class="sd">        :param attributes: the properties of the actors</span>
<span class="sd">        :param relations: the relations between the entities along with time index for the relations</span>
<span class="sd">        :param return_values: a direct string containing the return directive.</span>
<span class="sd">        :returns: index of the bond in the molecule</span>

<span class="sd">        .. note::</span>
<span class="sd">            Here we are expecting that if user has not specified the times on the dashboard, then we pass epmty string. If you</span>
<span class="sd">            store some other default in dashboard database then change this accordingly.</span>
<span class="sd">        .. note:: The return _values is directly used as a string in the cypher query, so the user can use AS and other similar cypher directives while specifying the query.</span>
<span class="sd">        .. todo:: Support to compose queries using OR. For example, currently compostion of relationships or attribute properties like all tweets(t) which are retweets of t1 or quoted t2, is not supported. Use cypher union for this.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;We are generating the query &quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------------------------------&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">actors</span><span class="p">,</span> <span class="n">attributes</span><span class="p">,</span> <span class="n">relations</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------------------------------&quot;</span><span class="p">)</span>
        <span class="n">relations</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="c1">##required because we write the ma_c first and then ma_c2.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">unwind_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">actors</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">actors</span><span class="p">)):</span>
            <span class="n">entity_name</span> <span class="o">=</span> <span class="n">actors</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">entity_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">prop_value</span> <span class="o">=</span> <span class="n">prop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span><span class="p">(</span><span class="n">prop_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;{&quot;</span> <span class="ow">and</span> <span class="n">prop_value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;}&quot;</span><span class="p">):</span>
                    <span class="n">unwind_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prop_value</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">entity_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">prop</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">prop_value</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_value&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">entity_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
        <span class="n">pprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">types</span><span class="p">)</span>
        <span class="n">pprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">already_described</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">##list of already specified users, if encountered again, just use the variable name and don&#39;t specify again</span>

        <span class="n">frame_times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">match_events_l</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">match_actors_l</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">match_actors_l2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">num_frames</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">relations</span><span class="p">:</span> <span class="c1">## a relation is(actor1,rel,actor2,time1,time2)</span>
            <span class="k">if</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">!=</span><span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
                <span class="n">num_frames</span><span class="o">+=</span><span class="mi">1</span>
                <span class="n">frame_times</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">num_frames</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
                <span class="n">e_enc</span> <span class="o">=</span> <span class="n">encode</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">match_events_l</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">num_frames</span><span class="p">,</span><span class="n">e_enc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">e_enc</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">enc_left</span> <span class="o">=</span> <span class="n">encode_left</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">enc_right</span> <span class="o">=</span> <span class="n">encode_right</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">match_actors_l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">num_frames</span><span class="p">,</span><span class="n">enc_left</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">conditional_create</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">)</span>
                <span class="n">match_actors_l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">num_frames</span><span class="p">,</span><span class="n">enc_right</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">conditional_create</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="p">)</span>


            <span class="k">elif</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
                <span class="n">match_actors_l2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conditional_create</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">conditional_create</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="p">)</span>

        <span class="n">tweet_properties</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">actors</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;TWEET&quot;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]]:</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">att</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;hashtag&quot;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">att</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="s2">&quot;_value&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">unwind_list</span><span class="p">]):</span>
                            <span class="n">tweet_properties</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">conditional_create</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="s2">&quot;HAS_HASHTAG&quot;</span><span class="p">,</span><span class="s2">&quot;:HASHTAG {text:&quot;</span><span class="o">+</span><span class="n">att</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;}&quot;</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">tweet_properties</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">conditional_create</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="s2">&quot;HAS_HASHTAG&quot;</span><span class="p">,</span><span class="s2">&quot;:HASHTAG {text:&#39;&quot;</span><span class="o">+</span><span class="n">att</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;&#39;}&quot;</span><span class="p">))</span>
                    <span class="k">elif</span><span class="p">(</span><span class="n">att</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;url&quot;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">att</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="s2">&quot;_value&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">unwind_list</span><span class="p">]):</span>
                            <span class="n">tweet_properties</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">conditional_create</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="s2">&quot;HAS_URL&quot;</span><span class="p">,</span><span class="s2">&quot;:URL {expanded_url:&quot;</span><span class="o">+</span><span class="n">att</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;}&quot;</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">tweet_properties</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">conditional_create</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="s2">&quot;HAS_URL&quot;</span><span class="p">,</span><span class="s2">&quot;:URL {expanded_url:&#39;&quot;</span><span class="o">+</span><span class="n">att</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;&#39;}&quot;</span><span class="p">))</span>
                    <span class="k">elif</span><span class="p">(</span><span class="n">att</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;retweet_of&quot;</span><span class="p">):</span>
                        <span class="n">tweet_properties</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">conditional_create</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="s2">&quot;RETWEET_OF&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">conditional_create</span><span class="p">(</span><span class="n">att</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
                    <span class="k">elif</span><span class="p">(</span><span class="n">att</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;reply_of&quot;</span><span class="p">):</span>
                        <span class="n">tweet_properties</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">conditional_create</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="s2">&quot;REPLY_OF&quot;</span><span class="p">,</span><span class="n">conditional_create</span><span class="p">(</span><span class="n">att</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
                    <span class="k">elif</span><span class="p">(</span><span class="n">att</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;quoted&quot;</span><span class="p">):</span>
                        <span class="n">tweet_properties</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">conditional_create</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="s2">&quot;QUOTED&quot;</span><span class="p">,</span><span class="n">conditional_create</span><span class="p">(</span><span class="n">att</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
                    <span class="k">elif</span><span class="p">(</span><span class="n">att</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;has_mention&quot;</span><span class="p">):</span>
                        <span class="n">tweet_properties</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">conditional_create</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="s2">&quot;HAS_MENTION&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">conditional_create</span><span class="p">(</span><span class="n">att</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
        <span class="n">match_actors_solo_l</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">actors</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">already_described</span><span class="p">):</span>
                <span class="n">match_actors_solo_l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conditional_create</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="c1">##get the individual codes</span>
        <span class="c1"># print(&quot;The different lists are &quot;)</span>
        <span class="c1"># print(&quot;frame times :&quot;)</span>
        <span class="c1"># pprint(frame_times)</span>
        <span class="c1"># print(&quot;match_events_l: &quot;)</span>
        <span class="c1"># pprint(match_events_l)</span>
        <span class="c1"># print(&quot;match_actors_l and l2: &quot;)</span>
        <span class="c1"># pprint(match_actors_l)</span>
        <span class="c1"># pprint(match_actors_l2)</span>
        <span class="c1"># print(&quot;tweet_properties: &quot;)</span>
        <span class="c1"># pprint(tweet_properties)</span>

        <span class="n">uw</span> <span class="o">=</span> <span class="n">jj</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="n">unwinds</span><span class="p">)</span>
        <span class="n">uw_c</span> <span class="o">=</span> <span class="n">uw</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">unwinds</span> <span class="o">=</span> <span class="n">unwind_list</span><span class="p">)</span>

        <span class="n">mf</span> <span class="o">=</span> <span class="n">jj</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="n">match_frames</span><span class="p">)</span>
        <span class="n">mf_c</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">num_frames</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_frames</span><span class="p">)])</span>

        <span class="n">wf</span> <span class="o">=</span> <span class="n">jj</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="n">where_frames</span><span class="p">)</span>
        <span class="n">wf_c</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">frame_times</span><span class="o">=</span><span class="n">frame_times</span><span class="p">)</span>

        <span class="n">me</span> <span class="o">=</span> <span class="n">jj</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="n">match_events</span><span class="p">)</span>
        <span class="n">me_c</span> <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">events</span><span class="o">=</span><span class="n">match_events_l</span><span class="p">)</span>

        <span class="n">ma</span> <span class="o">=</span> <span class="n">jj</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="n">match_actors</span><span class="p">)</span>
        <span class="n">ma_c</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">events</span><span class="o">=</span><span class="n">match_actors_l</span><span class="p">)</span>

        <span class="n">ma2</span> <span class="o">=</span> <span class="n">jj</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="n">match_actors2</span><span class="p">)</span>
        <span class="n">ma_c2</span> <span class="o">=</span> <span class="n">ma2</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">rels</span><span class="o">=</span><span class="n">match_actors_l2</span><span class="p">)</span>

        <span class="n">ta</span> <span class="o">=</span> <span class="n">jj</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="n">tweet_attribs</span><span class="p">)</span>
        <span class="n">ta_c</span> <span class="o">=</span> <span class="n">ta</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">tweet_properties</span><span class="o">=</span><span class="n">tweet_properties</span><span class="p">)</span>

        <span class="n">mas</span> <span class="o">=</span> <span class="n">jj</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="n">match_actors_solo</span><span class="p">)</span>
        <span class="n">mas_c</span> <span class="o">=</span> <span class="n">mas</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">actors</span><span class="o">=</span><span class="n">match_actors_solo_l</span><span class="p">)</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">jj</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
        <span class="n">r_c</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">ret_values</span><span class="o">=</span><span class="n">return_values</span><span class="p">)</span>
        <span class="c1">##final cleaning</span>
        <span class="n">uw_c</span> <span class="o">=</span> <span class="n">uw_c</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">mf_c</span> <span class="o">=</span> <span class="n">mf_c</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="n">wf_c</span> <span class="o">=</span> <span class="n">wf_c</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;AND&quot;</span><span class="p">)</span>
        <span class="n">me_c</span> <span class="o">=</span> <span class="n">me_c</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="n">ma_c</span> <span class="o">=</span> <span class="n">ma_c</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="n">ma_c2</span> <span class="o">=</span> <span class="n">ma_c2</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="n">ta_c</span> <span class="o">=</span> <span class="n">ta_c</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="n">mas_c</span> <span class="o">=</span> <span class="n">mas_c</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="n">r_c</span> <span class="o">=</span> <span class="n">r_c</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">uw_c</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">mf_c</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">wf_c</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">me_c</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ma_c</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ma_c2</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ta_c</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">mas_c</span><span class="p">)</span>

        <span class="c1">##get the complete query</span>
        <span class="n">unwind</span> <span class="o">=</span> <span class="n">uw_c</span>
        <span class="n">match1</span> <span class="o">=</span> <span class="s2">&quot;MATCH &quot;</span><span class="o">+</span><span class="n">mf_c</span>
        <span class="n">where1</span> <span class="o">=</span> <span class="n">wf_c</span>
        <span class="n">match2</span> <span class="o">=</span> <span class="s2">&quot;MATCH &quot;</span><span class="o">+</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">me_c</span><span class="p">,</span><span class="n">ma_c</span><span class="p">,</span><span class="n">ma_c2</span><span class="p">,</span><span class="n">ta_c</span><span class="p">,</span><span class="n">mas_c</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">])</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">r_c</span>
        <span class="n">tot_template</span> <span class="o">=</span> <span class="n">jj</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="n">total_query</span><span class="p">)</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unwind</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">match1</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">!=</span><span class="s2">&quot;MATCH&quot;</span><span class="p">):</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">match1</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">where1</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">!=</span><span class="s2">&quot;WHERE&quot;</span><span class="p">):</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">where1</span><span class="p">)</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">match2</span><span class="p">)</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
        <span class="n">tot_code</span> <span class="o">=</span> <span class="n">tot_template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">parts</span><span class="o">=</span><span class="n">parts</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">tot_code</span><span class="p">)</span>
        <span class="c1"># arguments = {}</span>
        <span class="c1"># for x in unwind_list:</span>
        <span class="c1">#     arguments[x[0]+&quot;_list&quot;] = x[1]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Query generation ended &quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------------------------------&quot;</span><span class="p">)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">return_values</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)]</span>
        <span class="n">return_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span><span class="n">tot_code</span><span class="p">,</span><span class="s2">&quot;inputs&quot;</span><span class="p">:</span><span class="n">unwind_list</span><span class="p">,</span><span class="s2">&quot;outputs&quot;</span><span class="p">:[</span><span class="n">x</span> <span class="k">for</span> <span class="n">subl</span> <span class="ow">in</span> <span class="n">temp</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">subl</span><span class="p">]}</span>
        <span class="k">return</span><span class="p">(</span><span class="n">return_dict</span><span class="p">)</span></div></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="n">actors</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;u&quot;</span><span class="p">,</span><span class="s2">&quot;USER&quot;</span><span class="p">),(</span><span class="s2">&quot;t&quot;</span><span class="p">,</span><span class="s2">&quot;TWEET&quot;</span><span class="p">),(</span><span class="s2">&quot;t1&quot;</span><span class="p">,</span><span class="s2">&quot;TWEET&quot;</span><span class="p">)]</span>
    <span class="n">attributes</span><span class="o">=</span><span class="p">[[],[(</span><span class="s2">&quot;hashtag&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">{hash}</span><span class="s2">&quot;</span><span class="p">)],[]]</span>
    <span class="n">relations</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;u&quot;</span><span class="p">,</span><span class="s2">&quot;TWEETED&quot;</span><span class="p">,</span><span class="s2">&quot;t&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">),(</span><span class="s2">&quot;u&quot;</span><span class="p">,</span><span class="s2">&quot;TWEETED&quot;</span><span class="p">,</span><span class="s2">&quot;t1&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)]</span>

    <span class="c1"># actors = [(&#39;x&#39;, &#39;USER&#39;), (&#39;u1&#39;, &#39;USER&#39;)] + [(&#39;t1&#39;, &#39;TWEET&#39;), (&#39;t2&#39;, &#39;TWEET&#39;)]</span>
    <span class="c1"># attributes = [[(&#39;id&#39;, &#39;12&#39;)], [(&#39;id&#39;, &#39;24&#39;)]]+[[(&#39;hashtag&#39;, &#39;BLUERISING&#39;)], [(&#39;retweet_of&#39;, &#39;t1&#39;), (&#39;has_mention&#39;, &#39;u1&#39;)]]</span>
    <span class="c1"># relations = [(&#39;x&#39;, &#39;FOLLOWS&#39;, &#39;u1&#39;, &#39;&#39;, &#39;&#39;), (&#39;x&#39;, &#39;TWEETED&#39;, &#39;t2&#39;, &#39;24&#39;, &#39;48&#39;)]</span>
    <span class="n">cq</span> <span class="o">=</span> <span class="n">CreateQuery</span><span class="p">();</span>
    <span class="n">return_values</span><span class="o">=</span><span class="s2">&quot;u.id,count(t1)&quot;</span>
    <span class="n">ret_dict</span> <span class="o">=</span> <span class="n">cq</span><span class="o">.</span><span class="n">create_query</span><span class="p">(</span><span class="n">actors</span><span class="p">,</span><span class="n">attributes</span><span class="p">,</span><span class="n">relations</span><span class="p">,</span><span class="n">return_values</span><span class="p">)</span>
    <span class="n">pprint</span><span class="p">(</span><span class="n">ret_dict</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>


    <span class="c1">##TODO</span>
    <span class="c1"># compostion of realationships or attribute properties like all tweets(t) which are retweets of t1 or quoted t2</span>
</pre></div>

           </div><!-- /.toBeIndexed -->
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo" class="contentinfo">
      <p class="show_copyright">
            &copy; Copyright 2018, Deepak Saini, Abhishek Gupta
      </p>
      <p class="show_sphinx">
        Built with <a href="http://sphinx-doc.org/" target="_blank">Sphinx</a> and
        <a href="https://github.com/TYPO3-Documentation/t3SphinxThemeRtd" target="_blank">t3SphinxThemeRtd.</a>
        Report theme issues <a href="https://github.com/TYPO3-Documentation/t3SphinxThemeRtd/issues" target="_blank">here.</a>
      </p>
      <p class="show_legalinfo">
        <a href="https://typo3.org/legal-info/" rel="nofollow">
          <span class="fa fa-legal"></span>&#32;Legal Info
        </a>
      </p>




  </div>

</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script type="text/javascript" src="../_static/jquery-ui/jquery-ui.min.js"></script>
      <script type="text/javascript" src="../_static/js/theme.js"></script>
      <script type="text/javascript" src="../_static/js/t3autocomplete.js"></script>

  

  
   
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   <script type="text/javascript" id="idPiwikScriptPlaceholder"></script></body>
</html>