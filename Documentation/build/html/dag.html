<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Composing multiple queries : DAG &mdash; Twitter Analytics 0.1 documentation</title>
  

  
  

  

  

  

  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="_static/jquery-ui/jquery-ui.min.css" type="text/css" />
  
    <link rel="stylesheet" href="_static/css/t3more.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Twitter Analytics 0.1 documentation" href="#"/>
        <link rel="next" title="Generating alerts using Apache Flink and Kafka" href="flink.html"/>
        <link rel="prev" title="About Post processing functions" href="postprocessing.html"/> 
  <script src="_static/js/modernizr.min.js"></script>
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        

        <ul class="sidebartop">

          <li class="docsite">
            <a href="https://docs.typo3.org"><img src="_static/img/typo3-documentation.png" class="logo" /></a>
          </li>

          <li class="project">
            <a href="index.html">
              Twitter Analytics<br>0.1</a>
          </li><li class="nolink search">
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search this project" id="searchinput" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div></li>

        </ul>

        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction to twitter analytics system</a><ul>
<li class="toctree-l2"><a class="reference internal" href="introduction.html#major-parts-of-the-system">Major parts of the system</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="twitter_stream.html">Read data from Twitter API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="twitter_stream.html#user-timeline-api">User Timeline API</a></li>
<li class="toctree-l2"><a class="reference internal" href="twitter_stream.html#stream-sample-api">Stream Sample API</a></li>
<li class="toctree-l2"><a class="reference internal" href="twitter_stream.html#user-timeline-api-code-documentation">User Timeline API Code Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="twitter_stream.html#stream-sample-api-code-documentation">Stream Sample API Code Documentation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="neo4j_data_ingestion.html">Ingesting data into Neo4j</a><ul>
<li class="toctree-l2"><a class="reference internal" href="neo4j_data_ingestion.html#data-stored-in-neo4j">Data stored in neo4j</a><ul>
<li class="toctree-l3"><a class="reference internal" href="neo4j_data_ingestion.html#user-network">User network</a></li>
<li class="toctree-l3"><a class="reference internal" href="neo4j_data_ingestion.html#tweet-network">Tweet network</a></li>
<li class="toctree-l3"><a class="reference internal" href="neo4j_data_ingestion.html#indexing-network">Indexing network</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="neo4j_data_ingestion.html#ingesting-the-data-into-neo4j-logic">Ingesting the data into neo4j : Logic</a><ul>
<li class="toctree-l3"><a class="reference internal" href="neo4j_data_ingestion.html#improving-ingestion-rate-using-transaction">Improving ingestion rate using transaction</a></li>
<li class="toctree-l3"><a class="reference internal" href="neo4j_data_ingestion.html#indexing">Indexing</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="neo4j_data_ingestion.html#running-the-ingestion-script">Running the ingestion script</a></li>
<li class="toctree-l2"><a class="reference internal" href="neo4j_data_ingestion.html#neo4j-ingestion-rates">Neo4j Ingestion Rates</a></li>
<li class="toctree-l2"><a class="reference internal" href="neo4j_data_ingestion.html#code-documentation-for-neo4j-data-ingestion">Code Documentation for Neo4j data ingestion</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="mongoDB_data_ingestion.html">Ingesting data into MongoDB</a><ul>
<li class="toctree-l2"><a class="reference internal" href="mongoDB_data_ingestion.html#why-store-in-mongodb">Why store in MongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="mongoDB_data_ingestion.html#data-format-in-mongodb">Data Format in mongoDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="mongoDB_data_ingestion.html#mongodb-v-s-neo4j">mongoDB v/s neo4j</a></li>
<li class="toctree-l2"><a class="reference internal" href="mongoDB_data_ingestion.html#ingesting-the-data-into-mongodb-logic">Ingesting the data into mongoDB : Logic</a><ul>
<li class="toctree-l3"><a class="reference internal" href="mongoDB_data_ingestion.html#improving-ingestion-rate-using-transactions">Improving ingestion rate using transactions</a></li>
<li class="toctree-l3"><a class="reference internal" href="mongoDB_data_ingestion.html#improving-ingestion-rate-using-parallel-multiple-process">Improving ingestion rate using parallel multiple process</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="mongoDB_data_ingestion.html#ingesting-the-data-into-mongodb-practical-side">Ingesting the data into mongoDB : Practical side</a></li>
<li class="toctree-l2"><a class="reference internal" href="mongoDB_data_ingestion.html#mongodb-ingestion-rates">MongoDB Ingestion Rates</a></li>
<li class="toctree-l2"><a class="reference internal" href="mongoDB_data_ingestion.html#module-ingest_raw">Code Documentation for mongoDB ingestion</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="neo4j_query_generation.html">Neo4j: API to generate cypher queries</a><ul>
<li class="toctree-l2"><a class="reference internal" href="neo4j_query_generation.html#template-of-a-general-query">Template of a general query</a><ul>
<li class="toctree-l3"><a class="reference internal" href="neo4j_query_generation.html#basic-abstraction">Basic Abstraction</a></li>
<li class="toctree-l3"><a class="reference internal" href="neo4j_query_generation.html#naming-entities">Naming entities</a></li>
<li class="toctree-l3"><a class="reference internal" href="neo4j_query_generation.html#variable-attributes">Variable attributes</a></li>
<li class="toctree-l3"><a class="reference internal" href="neo4j_query_generation.html#returns">Returns</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="neo4j_query_generation.html#creating-a-custom-query-through-dashboard-api-behind-the-scenes">Creating a custom query through dashboard API : Behind the scenes</a></li>
<li class="toctree-l2"><a class="reference internal" href="neo4j_query_generation.html#code-documentation-for-neo4j-query-generation">Code Documentation for Neo4j query generation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="mongoDB_query_generation.html">Generating queries in mongoDB</a><ul>
<li class="toctree-l2"><a class="reference internal" href="mongoDB_query_generation.html#generic-api-for-mongodb-idea">Generic API for mongoDB : Idea</a><ul>
<li class="toctree-l3"><a class="reference internal" href="mongoDB_query_generation.html#mongodb-query-execution-code-documentation">MongoDB query execution code documentation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="postprocessing.html">About Post processing functions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="postprocessing.html#need-of-post-processing-function">Need of post processing function</a></li>
<li class="toctree-l2"><a class="reference internal" href="postprocessing.html#format-of-post-processing-functions">Format of post processing functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="postprocessing.html#executing-post-processing-function">Executing post processing function</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Composing multiple queries : DAG</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#basic-terminology">Basic terminology</a></li>
<li class="toctree-l2"><a class="reference internal" href="#idea-behind-a-dag">Idea behind a DAG</a></li>
<li class="toctree-l2"><a class="reference internal" href="#building-a-dag-from-queries">Building a DAG from queries</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dag-in-airflow">DAG in airflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="#creating-custom-metric">Creating custom metric</a></li>
<li class="toctree-l2"><a class="reference internal" href="#code-documentation-for-dag-abstraction">Code Documentation for DAG abstraction</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="flink.html">Generating alerts using Apache Flink and Kafka</a><ul>
<li class="toctree-l2"><a class="reference internal" href="flink.html#alert-specification-abstraction">Alert Specification Abstraction</a></li>
<li class="toctree-l2"><a class="reference internal" href="flink.html#back-end-process">Back-end process</a></li>
<li class="toctree-l2"><a class="reference internal" href="flink.html#example-finding-viral-hashtags">Example - Finding viral hashtags</a></li>
<li class="toctree-l2"><a class="reference internal" href="flink.html#flink-code-generator-documentation">Flink Code Generator Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="flink.html#flink-api-documentation">Flink API Documentation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="benchmarking.html">Benchmarking the query answering</a><ul>
<li class="toctree-l2"><a class="reference internal" href="benchmarking.html#neo4j-queries">Neo4j queries</a><ul>
<li class="toctree-l3"><a class="reference internal" href="benchmarking.html#simple-queries">Simple Queries</a></li>
<li class="toctree-l3"><a class="reference internal" href="benchmarking.html#complex-queries">Complex Queries</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="benchmarking.html#mongodb-queries">MongoDB queries</a></li>
<li class="toctree-l2"><a class="reference internal" href="benchmarking.html#code-documentation-for-benchmarking">Code Documentation for benchmarking</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="dashboard_website.html">Dashboard Website</a><ul>
<li class="toctree-l2"><a class="reference internal" href="dashboard_website.html#major-parts-of-the-dashboard-website">Major parts of the dashboard website</a><ul>
<li class="toctree-l3"><a class="reference internal" href="dashboard_website.html#hashtags">Hashtags</a></li>
<li class="toctree-l3"><a class="reference internal" href="dashboard_website.html#mentions">Mentions</a></li>
<li class="toctree-l3"><a class="reference internal" href="dashboard_website.html#urls">URLs</a></li>
<li class="toctree-l3"><a class="reference internal" href="dashboard_website.html#alerts">Alerts</a></li>
<li class="toctree-l3"><a class="reference internal" href="dashboard_website.html#dag">DAG</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="dashboard_website.html#use-cases">Use Cases</a><ul>
<li class="toctree-l3"><a class="reference internal" href="dashboard_website.html#viewing-top-10-popular-hashtags">Viewing top 10 popular hashtags</a></li>
<li class="toctree-l3"><a class="reference internal" href="dashboard_website.html#viewing-usage-history-of-hashtag">Viewing usage history of  hashtag</a></li>
<li class="toctree-l3"><a class="reference internal" href="dashboard_website.html#viewing-sentiment-history-of-hashtag">Viewing sentiment history of  hashtag</a></li>
<li class="toctree-l3"><a class="reference internal" href="dashboard_website.html#creating-a-mongodb-query">Creating a mongoDB query</a></li>
<li class="toctree-l3"><a class="reference internal" href="dashboard_website.html#creating-neo4j-queries">Creating neo4j queries</a></li>
<li class="toctree-l3"><a class="reference internal" href="dashboard_website.html#create-post-processing-function">Create Post processing function</a></li>
<li class="toctree-l3"><a class="reference internal" href="dashboard_website.html#view-queries">View Queries</a></li>
<li class="toctree-l3"><a class="reference internal" href="dashboard_website.html#create-dag">Create DAG</a></li>
<li class="toctree-l3"><a class="reference internal" href="dashboard_website.html#view-dags">View DAGs</a></li>
<li class="toctree-l3"><a class="reference internal" href="dashboard_website.html#create-custom-metric">Create Custom metric</a></li>
<li class="toctree-l3"><a class="reference internal" href="dashboard_website.html#create-alert">Create Alert</a></li>
<li class="toctree-l3"><a class="reference internal" href="dashboard_website.html#view-alerts">View Alerts</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="running.html">Getting the system running</a><ul>
<li class="toctree-l2"><a class="reference internal" href="running.html#setting-up-the-environment">Setting up the environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="running.html#running-the-dashboard">Running the dashboard</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Twitter Analytics</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
    <li>Composing multiple queries : DAG</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/dag.rst.txt" rel="nofollow">
                <span class="fa fa-binoculars"></span>&#32;View page source
            </a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody" class="toBeIndexed">
            
  <div class="section" id="composing-multiple-queries-dag">
<h1>Composing multiple queries : DAG<a class="headerlink" href="#composing-multiple-queries-dag" title="Permalink to this headline">¶</a></h1>
<div class="section" id="basic-terminology">
<h2>Basic terminology<a class="headerlink" href="#basic-terminology" title="Permalink to this headline">¶</a></h2>
<p>When we say <strong>Query</strong>, it means an one of the following three things:</p>
<blockquote>
<div><ul class="simple">
<li>MongoDB query : A query not capable of giving any network information</li>
<li>Neo4j query : A network based and/or time indexed query on the twitter network</li>
<li>Post processing function : A python function which takes outputs of query(ies) as inputs and transforms them to give the output</li>
</ul>
</div></blockquote>
<p><strong>DAG</strong> stands for directed acyclic graph. Thus it a directed graph with no cycles. The idea behind a DAG is to compose multiple queries to build a complex queries. A DAG has nodes and has directed connections connections between the nodes. Each node as a query associated with it.</p>
</div>
<div class="section" id="idea-behind-a-dag">
<h2>Idea behind a DAG<a class="headerlink" href="#idea-behind-a-dag" title="Permalink to this headline">¶</a></h2>
<p>As mentioned above, our main idea is to provide the user an easy abstraction to build complex queries. But apart from this there are several functions that the abstraction of a DAG seems to serve, which we list below:</p>
<blockquote>
<div><ul class="simple">
<li>Provide an abstraction to build complex queries from simple queries.</li>
<li>A particular database may be suited to answer particular type of queries. In fact this is the main reason behind storing data in mongoDB to answer commonly encountered queries. We expect the user to have a basic understanding of the database schemas and thus be able to have an idea of efficiency of the two databases in answering specific queries. Having such knowledge, the user can compose queries from different databases in sake of efficiency.</li>
<li>It may be easy to do some projection of data output by a query post the execution, rather than coding it in the cypher in case of neo4j, or the aggregation pipeline in case of mongoDB. Thus, given the DAG abstraction, the user can feed the output of the query into a postprocessing node.</li>
<li>On similar lines as above, the user may need to aggregate multiple outputs from different queries in a postprocessing function in a custom manner not supported by the query mechanism of the databases.</li>
<li>Breaking a big query into smaller ones may be beneficial from the end user point of view because by doing so we can show the incremental results of the smaller parts(as they are executed) to the user instead of waiting for the entire big query to execute.</li>
</ul>
</div></blockquote>
<p>In this abstraction, a single query can also be treated as a DAG, one having a single node and no connections.</p>
<p>We store the queries that the user creates through the dashboard. The user can then specify the structure of the DAG network by uploading a file in which he specifies how outputs and inputs of queries are connected. We provide the details in the next section.</p>
</div>
<div class="section" id="building-a-dag-from-queries">
<h2>Building a DAG from queries<a class="headerlink" href="#building-a-dag-from-queries" title="Permalink to this headline">¶</a></h2>
<p>A DAG is composition of queries in which we need to specify how the outputs of queries upstream feed into the inputs of the downstream ones.</p>
<p>We explain how to build the queries with the help on an example. Let us build a DAG to get the most active users. Refer to this image(the green queries represent mongoDB queries and blue ones represent neo4j queries):</p>
<img alt="_images/example_query.jpg" src="_images/example_query.jpg" />
<p>First we need to build the three queries separately, let us say we have the built queries as:</p>
<blockquote>
<div><ul class="simple">
<li><dl class="first docutils">
<dt>mongoDB query(most_popular_hashtags_20 - Node 1) - 20 most popular hashtags in total</dt>
<dd><ul class="first last">
<li>INPUTS  : limit(number of records to return)</li>
<li>OUTPUTS : hashtags(list of popular hashtags, arranged by count in decreasing order), counts(list of their corresponding counts)</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>mongoDB query(most_popular_mentions_20 - Node 2) - 20 most popular users(in terms of number of mentions) in total</dt>
<dd><ul class="first last">
<li>INPUTS  : limit(number of records to return)</li>
<li>OUTPUTS : user_metions(list of popular users, arranged by count in decreasing order), counts(list of their corresponding counts)</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>neo4j query(active_users - Node 3)   - userIds and their tweet counts who have used one of the popular hashtags atleast once and have tweeted with one of the popular user mentions atleast once</dt>
<dd><ul class="first last">
<li>INPUTS  : hash_in(list of 20 most popular hashtags), users_in(list of 20 most popular users)</li>
<li>OUTPUTS : userIds(list of required users), tweet_counts(total number of their tweets)</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<p>This query is demonstrated by the block diagram below also:</p>
<img alt="_images/example_query_detailed.jpg" src="_images/example_query_detailed.jpg" />
<p>As mentioned in neo4j query generation section, we expect all the inputs to the neo4j query to be  list of native objects. We put a similar constraint on the inputs to post processing function. Keeping this in mind, to ensure consistency and a seamless flow of information, the outputs of each query(mongoDB, neo4j or postprocessing function) is expected to be a list. Thus each node in the DAG accepts a dictionary as input in which the values are lists and similarly returns a dictionary with list values. The keys in both dictionary is the name of the inputs/outputs, as specified in the query generation.</p>
<p>The only place where the list input breaks is in case of mongoDB query as they require some basic inputs which can directly be provided as native objects(for example the limit input to the above two mongoDB queries).</p>
<p>Further we need to specify which outputs of the queries are to be returned.</p>
<p>The example input file to create the above DAG looks something like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mi">3</span>
<span class="n">n1</span> <span class="n">most_popular_hashtags_20</span>
<span class="n">n2</span> <span class="n">most_popular_mentions_20</span>
<span class="n">n3</span> <span class="n">active_users</span>
<span class="n">INPUTS</span><span class="p">:</span>
<span class="n">CONNECTIONS</span><span class="p">:</span>
<span class="n">n1</span><span class="o">.</span><span class="n">hashtag</span> <span class="n">n3</span><span class="o">.</span><span class="n">hashtag</span>
<span class="n">n2</span><span class="o">.</span><span class="n">userId</span> <span class="n">n3</span><span class="o">.</span><span class="n">um_id</span>
<span class="n">RETURNS</span><span class="p">:</span>
<span class="n">n3</span><span class="o">.</span><span class="n">userId</span>
<span class="n">n3</span><span class="o">.</span><span class="n">count</span>
</pre></div>
</div>
<p>Observe the structure of the file.</p>
<blockquote>
<div><ul class="simple">
<li>Line 1 contains the number of nodes in the DAG.</li>
<li>The following number of nodes lines contain the name of the nodes and  each node corresponds to which query.</li>
<li>Then a line contains the keyword “INPUTS:”. The inputs to the queries in the DAG are specified here. For example, had the <code class="docutils literal"><span class="pre">n1.hashtag</span></code> variable been taken as an input rather than feeding from the output of an upstream query, it would have been specified as <code class="docutils literal"><span class="pre">n1.hashtag</span> <span class="pre">[&quot;hash1&quot;,&quot;hash2&quot;]</span></code>.</li>
<li>Then a line containing the keyword “CONNECTION:”. Below the connections in the DAG are specified.</li>
<li>And finally a line contains the keyword “RETURNS:”. Below, we specify the outputs of the queries which are to be returned.</li>
</ul>
</div></blockquote>
<p>Please note that, all the outputs of all the queries can be seen in XComs in airflow and also in the logs of the DAG run. But we provide the user to specify the things of interest to the user, through the RETURN variables. This will be useful in case we provide a functionality to observe the variation of a quantity over periodic DAG runs in future. Presently we don’t have such a functionality in our Dashboard, though providing such a functionality shouldn’t be difficult.</p>
</div>
<div class="section" id="dag-in-airflow">
<h2>DAG in airflow<a class="headerlink" href="#dag-in-airflow" title="Permalink to this headline">¶</a></h2>
<p>To create a DAG in airflow, we need to create a file in the dags folder in the AIRFLOW_HOME directory. So, when the user specifies the DAG through out dashboard, we generate a python file in the mentioned folder. The newly created DAG is registered with airflow after sometime(airflow has a heartbeat thread running, which looks for new DAGs in the folder periodically)
We generate the code to specify the dag in airflow something like this.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">task_0</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;node_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;n1&quot;</span><span class="p">),</span>
    <span class="n">python_callable</span><span class="o">=</span><span class="n">execute_query</span><span class="p">,</span>
    <span class="n">op_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;node_name&#39;</span><span class="p">:</span><span class="s2">&quot;n1&quot;</span><span class="p">},</span>
    <span class="n">provide_context</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="n">dag</span><span class="o">=</span><span class="n">dag</span><span class="p">)</span>

<span class="n">task_1</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;node_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;n2&quot;</span><span class="p">),</span>
        <span class="n">python_callable</span><span class="o">=</span><span class="n">execute_query</span><span class="p">,</span>
        <span class="n">op_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;node_name&#39;</span><span class="p">:</span><span class="s2">&quot;n2&quot;</span><span class="p">},</span>
        <span class="n">provide_context</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">dag</span><span class="o">=</span><span class="n">dag</span><span class="p">)</span>

<span class="n">task_2</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
        <span class="n">task_id</span><span class="o">=</span><span class="s1">&#39;node_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;n3&quot;</span><span class="p">),</span>
        <span class="n">python_callable</span><span class="o">=</span><span class="n">execute_query</span><span class="p">,</span>
        <span class="n">op_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;node_name&#39;</span><span class="p">:</span><span class="s2">&quot;n3&quot;</span><span class="p">},</span>
        <span class="n">provide_context</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">dag</span><span class="o">=</span><span class="n">dag</span><span class="p">)</span>
<span class="n">task_0</span> <span class="o">&gt;&gt;</span> <span class="n">task_2</span>
<span class="n">task_1</span> <span class="o">&gt;&gt;</span> <span class="n">task_2</span>
</pre></div>
</div>
<p>In the above code, the execute query is the function in which we execute queries and pass on their outputs to XComs to be used by the downstream nodes.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Pushing onto XComs</span>
<span class="n">context</span><span class="p">[</span><span class="s1">&#39;task_instance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">xcom_push</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
<span class="c1"># Pulling from XComs</span>
<span class="n">context</span><span class="p">[</span><span class="s1">&#39;task_instance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">xcom_pull</span><span class="p">(</span><span class="n">task_ids</span><span class="o">=</span><span class="n">get_task_from_node</span><span class="p">(</span><span class="n">mapp</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">dag_id</span> <span class="o">=</span> <span class="s2">&quot;active_users_dag&quot;</span><span class="p">,</span><span class="n">key</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
</pre></div>
</div>
<p>Apart from this, some of the DAG properties which needs to be specified in airflow are generated as the default ones. For example the <code class="docutils literal"><span class="pre">start_date</span></code> property is specified as the current time.</p>
<p>Airflow provides certain other useful properties which may be of interest to the user(when the system becomes huge). For example, the user can set an email-address on which a notification will be sent in case of the success and/or failure of tasks. But, taking all these inputs though our dashboard to generate the DAG, is like create a complete front-end wrapper over the airflow system, which is not out aim. If the user does wish to use the more involved airflow properties, he/she can always edit the source of the generated dag file. Also, if the need arises to provide the user such functionality through our dashboard, then modifying the code to generate an additional line in the dag python file is easy.</p>
<p>Further on airflow, different views of the DAG can be observed, some of the views which are of particular interest to us are the following :</p>
<blockquote>
<div><ul class="simple">
<li>Tree view - A view which tells the parallel streams in the DAG. We can specify how many parallel worker threads to have in airflow.</li>
<li>Graph view - A graph view specifying the connections between the nodes of the DAG.</li>
<li>Gant view - activates after the DAG has been executed, tells how much time taken by each query to execute.</li>
</ul>
</div></blockquote>
<p>Also,airflow provides the functionality to schedule the DAG runs periodically and properly stores the logs of each run. This can be leveraged in scenarios in which the user wants to run the same compositional query periodically.</p>
</div>
<div class="section" id="creating-custom-metric">
<h2>Creating custom metric<a class="headerlink" href="#creating-custom-metric" title="Permalink to this headline">¶</a></h2>
<p>Custom metric can be created on top of the DAG. A custom metric is nothing but a graphical view of the data output from the DAG execution.</p>
<p>To view a custom metric, the user is required to specify the following things:</p>
<blockquote>
<div><ul class="simple">
<li>A DAG : The outputs of any queries in the DAG can be used to create the custom metric.</li>
<li>A post processing function : accepts as inputs the outputs of any of the queries in the DAG and outputs a x and y coordinates to be used for plotting.</li>
<li>Either mapping between the inputs of the post processing function and the outputs of the queries in the DAG or fixed native values to the inputs.</li>
</ul>
</div></blockquote>
<p>To display the custom metric, the DAG is executed to feed data into the post processing function. The user can choose to view the metric in either of these formats:</p>
<blockquote>
<div><ul class="simple">
<li>Plot : The x and y coordinates are plotted using plotly through an Ajax call and displayed on the dashboard.</li>
<li>Table : The values are displayed in table format again using an Ajax call.</li>
</ul>
</div></blockquote>
<p>An example of creating a custom metric will be provided in the <a class="reference internal" href="dashboard_website.html#dashboard-website"><span class="std std-ref">Dashboard Website</span></a> section.</p>
</div>
<div class="section" id="code-documentation-for-dag-abstraction">
<h2>Code Documentation for DAG abstraction<a class="headerlink" href="#code-documentation-for-dag-abstraction" title="Permalink to this headline">¶</a></h2>
<p>Here we provide a documentation of the code used to generate, execute the DAG.</p>
<span class="target" id="module-create_dag"></span><p>Module to generate and store the DAG created by the user. Constains functions to generate DAG for the airflow
dashboard also.</p>
<p>The <a class="reference internal" href="#module-create_dag" title="create_dag"><code class="xref py py-mod docutils literal"><span class="pre">create_dag</span></code></a> module contains the classes:</p>
<ul class="simple">
<li><a class="reference internal" href="#create_dag.DAG" title="create_dag.DAG"><code class="xref py py-class docutils literal"><span class="pre">create_dag.DAG</span></code></a></li>
</ul>
<p>When we instantiate an object of the class, the network source of the DAG is parsed to get parameters.
One can use the function <a class="reference internal" href="#create_dag.DAG.feed_forward" title="create_dag.DAG.feed_forward"><code class="xref py py-func docutils literal"><span class="pre">create_dag.DAG.feed_forward()</span></code></a> to execute the networkx DAG and the
function <a class="reference internal" href="#create_dag.DAG.generate_dag" title="create_dag.DAG.generate_dag"><code class="xref py py-func docutils literal"><span class="pre">create_dag.DAG.generate_dag()</span></code></a> to generate an airflow DAG.</p>
<p>Example illustrating how to create a DAG  in which no input to no query is constant:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">queries</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;q1&quot;</span><span class="p">:[</span><span class="s2">&quot;query 1&quot;</span><span class="p">,[</span><span class="s2">&quot;inp1&quot;</span><span class="p">,</span><span class="s2">&quot;inp2&quot;</span><span class="p">],[</span><span class="s2">&quot;out1&quot;</span><span class="p">,</span><span class="s2">&quot;out2&quot;</span><span class="p">]],</span>
<span class="go">                        &quot;q2&quot;:[&quot;query 2&quot;,[&quot;inp1&quot;],[&quot;out1&quot;,&quot;out2&quot;]],</span>
<span class="go">                        &quot;q3&quot;:[&quot;query 3&quot;,[&quot;inp1&quot;,&quot;inp2&quot;,&quot;inp3&quot;],[&quot;out1&quot;]]}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">types</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;q1&quot;</span><span class="p">:</span><span class="s2">&quot;mongoDB&quot;</span><span class="p">,</span><span class="s2">&quot;q2&quot;</span><span class="p">:</span><span class="s2">&quot;PostProcesing&quot;</span><span class="p">,</span><span class="s2">&quot;q3&quot;</span><span class="p">:</span><span class="s2">&quot;neo4j&quot;</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">constants</span> <span class="o">=</span> <span class="p">{}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># input_graph.txt contains the network of the DAG. For format see the documentation</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dag</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;input_graph.txt&quot;</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span><span class="n">queries</span><span class="p">,</span><span class="n">types</span><span class="p">,</span><span class="n">constants</span><span class="p">)</span>
</pre></div>
</div>
<p>Example of a query in which we use constants:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># queries and types as before</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">constants</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;q1&quot;</span><span class="p">:{</span><span class="s2">&quot;inp1&quot;</span><span class="p">:</span><span class="mi">3</span><span class="p">}}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># input_graph.txt contains the network of the DAG. For format see the documentation</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dag</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;input_graph.txt&quot;</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span><span class="n">queries</span><span class="p">,</span><span class="n">types</span><span class="p">,</span><span class="n">constants</span><span class="p">)</span>
</pre></div>
</div>
<p>Now to execute the graph provide a function which can execute the queries.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">dag</span><span class="o">.</span><span class="n">feed_forward</span><span class="p">(</span><span class="o">&lt;</span><span class="n">execute</span><span class="o">&gt;</span><span class="p">)</span>
</pre></div>
</div>
<p>Create a DAG in airflow, get the plotly div for the DAG to be displayed on the dashboard</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">dag</span><span class="o">.</span><span class="n">generate_dag</span><span class="p">(</span><span class="o">&lt;</span><span class="n">dag_name</span><span class="o">&gt;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dag</span><span class="o">.</span><span class="n">plot_dag</span><span class="p">()</span>
</pre></div>
</div>
<dl class="class">
<dt id="create_dag.DAG">
<em class="property">class </em><code class="descclassname">create_dag.</code><code class="descname">DAG</code><span class="sig-paren">(</span><em>network_file_source</em>, <em>queries</em>, <em>types</em>, <em>constants</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/create_dag.html#DAG"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#create_dag.DAG" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal"><span class="pre">object</span></code></p>
<p>This class contains the functions to deal with the abstraction of DAG in our system. Some of the functions
to this end, some of the functions are in the views.py file also.</p>
<p>The __init__ is called to initilaize a DAG object. It reads the source of the DAG network file passed to it as a string. It
parses the string and extracts te nodes, connections, inputs and returns from the file.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>network_file_source</strong> – a string contains the network specificaion of the DAG</li>
<li><strong>queries</strong> – a dictionary of queries with keys as the query names/postprocessing function names</li>
<li><strong>types</strong> – a dictionary containing the types of different queries</li>
<li><strong>constants</strong> – a dictionary of constant inputs to a query</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>For the queries parameter, the expectation depends on the type of query:</p>
<blockquote>
<div><ul class="simple">
<li>For neo4j queries it will be the query code, input, output list</li>
<li>For mongoDB queries it will be the partially formatted query specification, input, output list</li>
<li>For post processing functions it will be the function_definition, input, output list</li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The constants dictionary will contain only the mongoDB queries in current format</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We don’t do very comprehensive checking if the network is valid.
In case it is not a DAG, the user is notified of it. Other than that, there will be some python errors if some other issue is there.</p>
</div>
<dl class="method">
<dt id="create_dag.DAG.feed_forward">
<code class="descname">feed_forward</code><span class="sig-paren">(</span><em>execute</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/create_dag.html#DAG.feed_forward"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#create_dag.DAG.feed_forward" title="Permalink to this definition">¶</a></dt>
<dd><p>Do a topological sort and then do a BFS of the DAG to execute all the queries.
Expect that there is a function to evaluate a query given its inputs(as a dictionary) and returns a dictionary of outputs</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>execute</strong> – a function to execute the queries</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="create_dag.DAG.generate_dag">
<code class="descname">generate_dag</code><span class="sig-paren">(</span><em>dag_name</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/create_dag.html#DAG.generate_dag"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#create_dag.DAG.generate_dag" title="Permalink to this definition">¶</a></dt>
<dd><p>Create a python file for the DAG in the dags directory of AIRFLOW_HOME. Generate the airflow code for
the dag in the file. The templates used in the function are taken in the <a class="reference internal" href="#module-create_dag" title="create_dag"><code class="xref py py-mod docutils literal"><span class="pre">create_dag</span></code></a> module.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>dag_name</strong> – the name of the dag to be generated</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Currently it has the relative address of the folder as being contained in the myapp folder. Change it appropriately if you decide to
change the airflow home</p>
</div>
</dd></dl>

<dl class="method">
<dt id="create_dag.DAG.get_drawable_dag">
<code class="descname">get_drawable_dag</code><span class="sig-paren">(</span><em>G</em>, <em>queries</em>, <em>types</em>, <em>edges</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/create_dag.html#DAG.get_drawable_dag"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#create_dag.DAG.get_drawable_dag" title="Permalink to this definition">¶</a></dt>
<dd><p>Helper function for <a class="reference internal" href="#create_dag.DAG.plot_dag" title="create_dag.DAG.plot_dag"><code class="xref py py-func docutils literal"><span class="pre">create_dag.DAG.plot_dag()</span></code></a>. It gets the locations of the various figures
in the plotly plot of the DAG.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>queries</strong> – the queries in the DAG</li>
<li><strong>types</strong> – the types of queris. Not used, but can choose to get different colored rectangles for different query types</li>
<li><strong>edges</strong> – the edges in the DAG</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">a directed graph with the connections between inputs and outputs, the locations of bounding rectangles for the queries</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="create_dag.DAG.plot_dag">
<code class="descname">plot_dag</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/create_dag.html#DAG.plot_dag"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#create_dag.DAG.plot_dag" title="Permalink to this definition">¶</a></dt>
<dd><p>Get the plotly div for the DAG. Get the locations using the helper function and then just plot those and return the html div for the plot</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">the html div of the DAG plotly plot</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

</div>
</div>


           </div><!-- /.toBeIndexed -->
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="flink.html" class="btn btn-neutral float-right" title="Accesskey Alt(+Shift)+n" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="postprocessing.html" class="btn btn-neutral" title="Accesskey Alt(+Shift)+p" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo" class="contentinfo">
      <p class="show_source">
        <a href="_sources/dag.rst.txt" rel="nofollow">
          <span class="fa fa-binoculars"></span>&#32;View page source
        </a>
      </p>
      <p class="show_copyright">
            &copy; Copyright 2018, Deepak Saini, Abhishek Gupta
      </p>
      <p class="show_sphinx">
        Built with <a href="http://sphinx-doc.org/" target="_blank">Sphinx</a> and
        <a href="https://github.com/TYPO3-Documentation/t3SphinxThemeRtd" target="_blank">t3SphinxThemeRtd.</a>
        Report theme issues <a href="https://github.com/TYPO3-Documentation/t3SphinxThemeRtd/issues" target="_blank">here.</a>
      </p>
      <p class="show_legalinfo">
        <a href="https://typo3.org/legal-info/" rel="nofollow">
          <span class="fa fa-legal"></span>&#32;Legal Info
        </a>
      </p>




  </div>

</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script type="text/javascript" src="_static/jquery-ui/jquery-ui.min.js"></script>
      <script type="text/javascript" src="_static/js/theme.js"></script>
      <script type="text/javascript" src="_static/js/t3autocomplete.js"></script>

  

  
   
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   <script type="text/javascript" id="idPiwikScriptPlaceholder"></script></body>
</html>